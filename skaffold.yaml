apiVersion: skaffold/v1beta7
kind: Config
build:
  artifacts:
  - image: cedardevs/onestop-admin
    jibGradle:
      project: admin
  - image: cedardevs/onestop-search
    jibGradle:
      project: search
  - image: cedardevs/onestop-client
    jibGradle:
      project: client

deploy:
  helm:
    releases:
    ###############################################################################
    # API ADMIN
    ###############################################################################
    - name: onestop-admin
      chartPath: helm/onestop-admin
      values:
        # skaffold may not build/deploy w/the latest if this is not set here
        image: cedardevs/onestop-admin
      imageStrategy:
        helm: {}
      setValues:
        # allows onestop-admin to be exposed outside the cluster in dev
        # features are directly tied to `export SPRING_PROFILES_ACTIVE='feat1,feat2,...'
        # all features default to "false" in base chart, unless otherwise overridden
        features.icam: false
        features.manual-upload: false
        features.kafka-ingest: true
        features.sitemap: true
        # env.ELASTICSEARCH_HOST: onestop-dev-elasticsearch
        env.SCHEMA_REGISTRY_URL: http://psi-dev-cp-schema-registry:8081
        env.KAFKA_BOOTSTRAP_SERVERS: PLAINTEXT://psi-dev-cp-kafka:9092
        config: |-
          ---
          logging.level.org.cedar.onestop.api.admin: DEBUG
          ---
          spring:
            profiles: sitemap
          etl:
            sitemap:
              delay:
                initial: 60000
    ###############################################################################
    # API SEARCH
    ###############################################################################
    - name: onestop-search
      chartPath: helm/onestop-search
      values:
        # skaffold may not build/deploy w/the latest if this is not set here
        image: cedardevs/onestop-search
      imageStrategy:
        helm: {}
      setValues:
        service.type: NodePort
        service.nodePort: 30097
        # allows onestop-search to be exposed outside the cluster in dev
        # features are directly tied to `export SPRING_PROFILES_ACTIVE='feat1,feat2,...'
        # all features default to "false" in base chart, unless otherwise overridden
        features.login-gov: false
        features.sitemap: true
        # env.ELASTICSEARCH_HOST: onestop-dev-elasticsearch
        env.SITEMAP_CLIENT_PATH: https://sciapps.colorado.edu/onestop
        env.SITEMAP_API_PATH: https://sciapps.colorado.edu/onestop-search
#        config: |-
#          ---
#          logging.level.org.cedar.onestop.api.search: DEBUG
    ###############################################################################
    # CLIENT
    ###############################################################################
    - name: onestop-client
      chartPath: helm/onestop-client
      values:
        # skaffold may not build/deploy w/the latest if this is not set here
        image: cedardevs/onestop-client
      imageStrategy:
        helm: {}
      setValues:
        # allows onestop-search to be exposed outside the cluster in dev
        prefixPath: onestop
        apiSearch.endpoint: onestop-search:8080/onestop-search

    ###############################################################################
    # ELASTICSEARCH
    ###############################################################################
    - name: elasticsearch
      chartPath: helm/elasticsearch
      setValues:
        service.type: NodePort
        service.nodePort: 30092

    ###############################################################################
    # DEV DEPENDENCIES
    ###############################################################################
    - name: onestop-dev
      chartPath: helm/onestop-dev
